# ============ 04-gateway.yaml (ConfigMap) ============
apiVersion: v1
kind: ConfigMap
metadata:
  name: ocelot-config
  namespace: distributetmusicapp
data:
  ocelot.json: |
    {
      "Routes": [
        {
          "UpstreamPathTemplate": "/{everything}",
          "UpstreamHttpMethod": [ "GET" ],
          "DownstreamPathTemplate": "/{everything}",
          "DownstreamScheme": "http",
          "DownstreamHostAndPorts": [
            {
              "Host": "catalogservice", # Correct internal DNS name
              "Port": 8080
            }
          ],
          "LoadBalancerOptions": { "Type": "RoundRobin" },
          "FileCacheOptions": { "TtlSeconds": 15, "Region": "catalog-get" },
          "RateLimitOptions": { "EnableRateLimiting": true, "Period": "10s", "Limit": 3 },
          "Key": "catalog-get-cached"
        },
        {
          "UpstreamPathTemplate": "/{everything}",
          "UpstreamHttpMethod": [ "POST", "PUT", "DELETE", "PATCH" ],
          "DownstreamPathTemplate": "/{everything}",
          "DownstreamScheme": "http",
          "DownstreamHostAndPorts": [
            {
              "Host": "catalogservice", # Correct internal DNS name
              "Port": 8080
            }
          ],
          "LoadBalancerOptions": { "Type": "RoundRobin" },
          "Key": "catalog-write-no-cache"
        }
      ],
      "GlobalConfiguration": {
        "BaseUrl": "http://apigateway:8080",
        "RateLimitOptions": {
          "ClientIdHeader": "MyRateLimiting",
          "DisableRateLimitHeaders": false,
          "HttpStatusCode": 418,
          "QuotaExceededMessage": "Customize Tips!",
          "RateLimitCounterPrefix": "ocelot"
        }
      }
    }
---
# ============ 04-gateway.yaml (Deployment) ============
apiVersion: apps/v1
kind: Deployment
metadata:
  name: apigateway
  namespace: distributetmusicapp
spec:
  replicas: 2  # Increased from 1 to 2 for high availability
  selector:
    matchLabels:
      app: apigateway
  template:
    metadata:
      labels:
        app: apigateway
    spec:
      containers:
        - name: apigateway
          image: PLACEHOLDER_ECR_REGISTRY/musicapp-apigateway:latest  # Will be replaced by GitHub Actions
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
          env:
            - name: ASPNETCORE_ENVIRONMENT
              value: "Production"
            - name: ASPNETCORE_URLS
              value: "http://+:8080"
            - name: Redis__Host
              value: "redis" # Points to the Redis Service
            - name: Redis__Port
              value: "6379"
            - name: Redis__Db
              value: "0"
          volumeMounts:
            - name: ocelot-config
              mountPath: /app/ocelot.json
              subPath: ocelot.json
      volumes:
        - name: ocelot-config
          configMap:
            name: ocelot-config
---
# ============ 04-gateway.yaml (Service) ============
apiVersion: v1
kind: Service
metadata:
  name: apigateway
  namespace: distributetmusicapp
spec:
  selector:
    app: apigateway
  ports:
    - port: 8080
      targetPort: 8080
      protocol: TCP
  type: ClusterIP  # Changed from LoadBalancer - access via kubectl port-forward